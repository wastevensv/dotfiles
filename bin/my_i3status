#!/bin/sh

# Prepends timer status to i3bar.

i3status | (read line && echo "$line" && read line && echo "$line" && while :
do
    read line
    LINE="{${line#*\{},"
    REMAIN=$($HOME/.bin/tminus remain)
    if [[ $REMAIN == "E" ]]; then
        COLOR="#ffffff"
        TDIFF="No Timer"
    else
        if [[ $REMAIN -le 0 ]]; then
            COLOR="#ff0000"
            TDIFF="Timer: EXPIRED"
        elif [[ $REMAIN -le 900 ]]; then
            COLOR="#ffff00"
            TDIFF="Timer: "$(date -u -d "@$REMAIN" +"%H:%M:%S")
        else
            COLOR="#ffffff"
            TDIFF="Timer: "$(date -u -d "@$REMAIN" +"%H:%M:%S")
        fi
    fi
    LINE="{\"full_text\":\"${TDIFF}\",\"color\":\"${COLOR}\"},$LINE"
    if [ -f $HOME/.cache/task ]; then
       TASK=$(cat $HOME/.cache/task)
       LINE="{\"full_text\":\"${TASK}\",\"color\":\"#ffffff\"},$LINE"
    fi
    echo "[$LINE" || exit 1
done)
